import matplotlib.pyplot as plt
import numpy as np


class AlphaBeta:
    alpha: float
    beta: float

    velocity: np.ndarray
    position: np.ndarray

    def __init__(self, alpha: float, beta: float, initial_position: np.ndarray):
        self.alpha = alpha
        self.beta = beta
        self.position = initial_position
        self.velocity = np.zeros_like(initial_position, dtype=np.float32)

    def update(self, measurement: np.ndarray, dt: float) -> np.ndarray:
        assert dt != 0.0
        predicted_position = self.position + self.velocity * dt
        residual = measurement - predicted_position
        self.position = predicted_position + self.alpha * residual
        self.velocity += (self.beta * residual) / dt
        return self.position

    def get_position(self) -> np.ndarray:
        return self.position

    def predict(self, dt: float) -> np.ndarray:
        self.position += self.velocity * dt
        return self.position


# Raw data to help test the filter and determine alpha/beta
if __name__ == "__main__":
    road_angle = [-124.87532834460218, -131.14319901441016, -116.08559977828143, -130.41390110382915, -132.01853878001782,
     -130.74115387782965, -131.7038840274537, -131.7038840274537, -140.53863753279055, -140.53863753279055,
     -140.55536714291804, -140.55536714291804, -140.74518159059528, -140.76263288659845, -140.95410743116503,
     -140.87611188197442, -140.9722955479653, -141.06874169121753, -140.9905947179248, -141.08736068716368,
     -141.00900595749454, -141.00900595749454, -141.00900595749454, -140.930385597466, -140.930385597466,
     -140.94869951602334, -140.86960044301472, -140.96712648670882, -140.88781428439881, -140.98566755572497,
     -141.00432378217496, -140.9245819819825, -140.9245819819825, -140.84456587738688, -140.665921557971,
     -140.5852979743429, -140.60286067998078, -140.2434695058987, -139.8012126883005, -139.81640716148095,
     -139.9146183624078, -139.93024274766302, -139.93024274766302, -139.93024274766302, -139.93024274766302,
     -140.02907358178544, -140.02907358178544, -140.12819104185286, -140.12819104185286, -140.29521293661713,
     -140.84892164592895, -142.47573738554823, -143.7651280942071, -142.91416450904765, -144.25754902874732,
     -143.9198437836623, -142.75316187455886, -147.32472743413737, -140.19442890773482, -140.11041756103123,
     -144.37706069430436, -148.21274687833525, -144.02761295071508, -140.14369475967834, -140.05889804398845,
     -140.05889804398845, -140.07545237847899, -146.30993247402023, -146.8336453061607, -148.0311574626723,
     -140.3558250428552, -143.20470619156868, -148.58599120788892, -140.02611041569824, -146.1130405359483,
     -148.12686301872733, -147.7943993907652, -147.24452787024984, -145.93112292241145, -148.37133196989194,
     -147.88818512576572, -147.95959492616015, -147.6055773543846, -146.1173423438472, -147.40288312176523,
     -147.3807569288072, -142.76516601842533, -145.57658654496873, -147.69654895161275, -146.0353541630349,
     -140.39629223989905, -147.76556578105863, -146.88865803962798, -147.50520005514628, -146.48541670175862,
     -147.66981426494965, -141.39658521147223, -140.70130845446423, -140.70130845446423, -141.0502358228988,
     -148.8220546357317, -147.22512267573578, -146.9485532504185, -148.98294508375304, -147.89875110416446,
     -143.7852987178846, -144.92001296240204, -146.40447987914703, -146.88865803962798, -145.1886280084535,
     -144.50677198926567, -145.91411300581078, -142.44804196098335, -147.92213640108793, -141.2743345570818,
     -150.8838537339211, -152.08706154272343, -152.47092812754337, -151.71922880922543, -150.3369113377359,
     -152.75288842974936, -153.02472352123849, -150.62423458118684, -149.27251338440036, -143.29714496983686,
     -151.33604288971847, -147.79230202714092, -150.38846783275898, -150.34527721166998, -153.29621839303442,
     -149.84845201817788, -154.2692943984688, -149.79676224505735, -150.70099125499027, -150.43964553531927,
     -152.11971556194723, -153.01469391820524, -153.72578784527258, -144.37978729030394, -152.99869497302157,
     -151.67501769018875, -150.6221002627109, -147.1836565859874, -148.507838875273, -148.88466768525817,
     -149.26451229807992, -149.42077312751098, -156.10483858492964, -153.434948822922, -155.75647941275474,
     -154.39781244855823, -155.08437149159647, -144.8788296975036, -154.76373635309642, -154.16946985717684,
     -153.73729841489867, -152.10272896905238, -144.96111209859154, -147.9498544732788, -153.9177669968653,
     -153.434948822922, -151.7983717813053, -153.58493743190948, -152.66072865799396, -153.1418783378957,
     -149.34933204294714, -149.71756656805812, -153.57927038044468, -153.434948822922, -151.55707137563664,
     -151.33181160846826, -148.2079284627791, -154.16017312198127, -154.31185656435267, -144.02572741481183,
     -150.39554925399509, -151.2707312155448, -152.80187205149088, -148.12463724841095, -154.19884728385202,
     -155.20186754656228, -155.20186754656228, -154.59228189105156, -148.77159971708244, -148.07912378006682,
     -146.993348723587, -150.01836063115067, -153.5869266614859, -146.78052377691543, -153.58896936459433,
     -150.15954618200192, -153.27710960922013, -152.46117665042448, -153.12186024790137, -145.44562205652514,
     -152.81049638792203, -144.0782408353934, -144.0782408353934, -143.96208073253564, -143.96208073253564,
     -143.96208073253564, -151.57095116691386, -151.7251347787805, -151.92751306414706, -151.51416391023307,
     -151.51416391023307, -151.2707312155448, -149.77162149216753, -150.06848815949223, -148.76078511179125,
     -148.76078511179125, -148.47315811273114, -147.8173682327952, -147.0305960965379, -147.4960110444375,
     -146.56013079421777, -146.30993247402023, -145.27535816487813, -144.2933085993971, -144.52867513668704,
     -144.89392066973542, -143.87055585675915, -143.2228138905749, -143.40337109056082, -142.6789638073687,
     -142.0457691248675, -141.6912644325523, -141.34019174590992, -141.05898772397833, -138.0848123304976,
     -139.03771062097712, -139.08561677997488, -137.45904399010462, -134.63035493815298, -129.87683446287187,
     -134.2654789657452, -130.2363583092738, -145.43747535111817, -126.28526712513884, -128.57125225117014,
     -131.2359651350943, -145.61965527615513, -145.6934826843665, -124.56252464888182, -129.40066066347944,
     -116.26663835708312, -123.35402575151677, -121.28265368163969, -119.81416273779868, -119.98163936884934,
     -117.08355086436868, -118.88658176691071, -112.06789956241022, -122.47119229084849, -121.93844891667189,
     -114.38637110180139, -117.7904424794521, -114.32557523912612, -118.72032679786948, -117.19812794850912,
     -107.5924245621816, -105.19524852681988, -103.70696100407982, -109.91640599380908, -104.82647997035568,
     -102.144278049567, -105.8323866204222, -98.61564818416412, -89.11859600341786, -104.82647997035568,
     -105.03781590358226, -145.60808504620073, -108.69898280418113, -145.4983272967936, -145.4983272967936,
     -145.4983272967936, -108.68735150521117, -97.30575953331083, -100.71312302279104, -99.70665240933971,
     -106.99082329198617, -90.0, -105.12400730831057, -92.09525256462385, -89.32596310201549, -107.04903097210982,
     -107.52556837372288, -88.74095479282474, -102.77124256490144, -110.47227951974192, -87.48312434306048,
     -104.78272604261568, -91.36392753160293, -91.30195267257888, -146.0087747769668, -89.3414568224364,
     -90.66619997018314, -145.96934070274318, -146.04326521296917, -86.37851529588266, -146.04094018032373,
     -81.02737338510362, -83.91147184580483, -81.65610841596691, -82.1998121158183, -81.31364541876334,
     -145.38402068762016, -79.76519723657678, -145.49865064188134, -145.41959675959794, -145.41959675959794,
     -145.41959675959794, -145.07629747118673, -144.81559888275368, -144.6700884197193, -144.52594881098037,
     -144.4146683962971, -144.33499846313825, -144.33499846313825, -144.33499846313825, -144.25501859448713,
     -144.3665099570121, -144.3665099570121, -144.28632343886932, -144.28632343886932, -144.28632343886932,
     -144.28632343886932, -144.20582350963653, -144.14383866491409, -144.06344408297727, -144.06344408297727,
     -143.98273703997464, -73.44292862436335, -75.41108126712537, -143.90171603289198, -143.82037955202108,
     -143.73872608095996, -143.73872608095996, -143.65675409661466, -143.76854633988225, -143.68635458123666,
     -75.96375653207353, -78.97654403625687, -81.46923439005187, -78.69006752597979, -77.31961650818018,
     -76.13031356149496, -77.61924307119283, -80.88213724620421, -83.13000769178574, -82.45057823173673,
     -78.146995832256, -78.82616175818528, -83.0470425318261, -76.63978155523552, -88.58557678859785,
     -81.46923439005187, -142.12501634890182, -79.24903300681196, -73.57069854846661, -73.57069854846661,
     -77.0053832080835, -76.3099503825345, -74.9315118405078, -70.90650799951439, -75.96375653207353,
     -76.47683934958398, -141.6561164343312, -72.22867917709124, -141.6561164343312, -75.37912601136834,
     -72.64597536373867, -73.96005669395034, -73.96005669395034, -73.49563861824498, -75.6354175503028,
     -80.77011375627228, -68.81865049973376, -72.64597536373867, -141.76961952762395, -141.76961952762395,
     -71.77492488864554, -141.7938305604864, -74.80475147318012, -70.30137862541973, -68.19859051364818,
     -72.84757825978816, -67.32865637801915, -66.71393508177644, -65.22485943116808, -73.10135130596177,
     -71.3504612459486, -73.68614757373945, -76.13031356149496, -142.08689541007368, -142.08689541007368,
     -72.43972794819932, -73.7676493388438, -75.11373315098244, -142.03669436279517, -92.86240522611175,
     -88.56790381583535, -90.71615994547041, -72.43972794819932, -92.1475854282985, -94.23639479905884,
     -72.20401107606962, -85.76360520094116, -72.64597536373867, -78.82616175818528, -74.6237487511738,
     -89.28384005452959, -73.49563861824498, -76.63978155523552, -98.42696902148067, -75.46554491945989,
     -76.13031356149496, -97.64040676102677, -95.97432328648063, -142.06170612106266, -81.30449712257523,
     -78.3106308245608, -142.20137673840455, -83.51692630710276, -142.3424808665535, -142.3424808665535,
     -74.14063373339431, -72.53607310815717, -82.95423087513251, -88.02506598911803, -75.65066795705286,
     -72.18111108547723, -70.74070835623284, -72.20401107606962, -70.48412699041731, -66.52900688183912,
     -68.19859051364818, -69.7024302277713, -64.09349200048563, -63.10376303450663, -63.43494882292201,
     -67.20347853205739, -64.75947073521321, -63.43494882292201, -61.27967320213052, -63.43494882292201,
     -65.89776549883887, -65.50142580856624, -67.83365417791754, -68.07822140604085, -62.87869659584134,
     -67.04591346237152, -71.98023071822286, -71.56505117707799, -70.3461759419467, -67.61986494804043,
     -67.61986494804043, -61.29404745659892, -71.56505117707799, -71.77492488864554, -64.01076641616699,
     -67.58385252065636, -64.90374953730785, -67.69379494509236, -60.17291534552527, -59.60127228583394,
     -77.79953127261922, -67.27026792005532, -83.33334010909863, -61.55707137563666, -83.8298249049704,
     -81.54497232282256, -63.09390654406316, -82.5685920288275, -86.53177074108285, -75.96375653207353,
     -83.6598082540901, -81.74056202012119, -47.62640563829075, -86.53177074108285, -66.5953104489677,
     -100.30484646876603, -101.30993247402021, -93.66778805553143, -109.06919353734814, -65.22485943116808,
     -65.22485943116808, -64.04123073843937, -63.43494882292201, -70.44174846300257, -71.79151552941917,
     -79.24903300681196, -70.48412699041731, -71.1468412355809, -71.77492488864554, -77.76388849058367,
     -73.96005669395034, -80.3112134396332, -71.1468412355809, -69.90476880809518, -69.29096240835098]
    wheel_angle = [-19.01381754724446, -35.714238310949895, -6.227474554253948, -26.680852365571738, -22.548121966146955,
     -18.76658130710831, -72.48853931666982, -75.2400869133686, -15.03454525264338, -16.596955498701515,
     -10.202186996928065, -17.032245789629105, -17.766056767971065, -17.11976334104912, -16.26829094828664,
     -24.919109759412407, -13.95856023498806, -12.0605372928526, -5.90475210254663, -13.219744721729189,
     -15.680954015497148, -7.204184515912624, 5.656184295988861, -8.10837550164663, 4.811627848397302,
     5.500288580416175, -15.119556361932252, -13.791590697612378, -7.510354415467007, -21.538926300443055,
     4.196436742214594, -15.210863062176115, -24.434100196183902, -16.745756339309324, -21.623815329161353,
     -7.706412293043054, -19.483156823068743, -13.088830913871542, -21.156640167549526, -72.75189041531252,
     -16.17770903540124, -17.634955306471642, -15.645350849140536, -16.450103037078417, -20.699077736590954,
     -74.07112461774554, -21.297903577403826, -23.835714264021767, -19.035923698262536, -67.28290322698992,
     -21.045408633001955, -20.61599382474508, -22.65823816392643, -71.62173524399456, -28.471424171052842,
     -29.4049536841104, -28.420468346253813, -28.821309050601467, -23.027395038163064, -70.25430805594202,
     -32.520208656206236, -69.65653473013644, -25.411720128891, -25.664910819741248, -68.60849947617874,
     -31.06483331466275, -28.203136073543124, -25.026238157673397, -28.505545313180303, -28.58185385423745,
     -37.255830386004845, -31.929767782701564, -68.764467425885, -32.074517921542224, -26.039998264713915,
     -25.023164890952895, -14.941485312068119, -24.588971260836896, -18.25361311159304, -68.71294283436643,
     -17.090850668543926, -16.804961734446227, -17.655686218544968, -16.509390031314133, -15.129913318850747,
     -16.512222323187622, -73.07831916824419, -15.063825135686548, -15.81310874059541, -15.648111352666817,
     -15.923539504236984, -15.834873492982657, -77.1360787129751, -16.5828811600189, -75.98860989257729,
     -29.048156493432487, -34.064559287735044, -20.227651157807458, -21.939490427969805, -21.048622840176073,
     -22.210661833734292, -28.08313546968811, -28.026190625178998, -27.901144490443187, -16.56135843501313,
     -16.705796645640575, -17.026129889215785, -16.937958548715994, -16.59955661397902, -16.895022817867567,
     -17.65873611923832, -17.03662336584595, -75.3602175139505, -16.78076321350495, -16.378821551921366,
     -15.960992213232709, -15.501969802461506, -15.630901420330447, -74.41861415358015, -36.124213846603794,
     -16.289751464695296, -16.02099218592109, -15.588436214229896, -16.788767350047365, -16.293729333064725,
     -16.068028763086573, -24.792382550483076, -29.925087480584963, -34.190121646518314, -17.10824392713804,
     -18.234619901469312, -20.462230986578547, -21.263846604796893, -31.935134519729907, -20.435702069781044,
     -20.028697905557074, -38.584027508467926, -36.630933433955484, 9.870828810974691, -18.47500954278759,
     -35.89147793170257, 15.082053500277452, -17.278861707066014, -18.40112496895062, -6.157295559445882,
     -18.40913871061336, -13.40773688499832, -37.68510865102145, -39.57653816364356, -39.71114365895097,
     -39.11979204438823, -38.532309230730434, -36.92144991226667, -35.557802744353424, -37.23467119709668,
     -17.937845369923323, -47.61028006205532, -32.41680585681477, -31.467756903403338, -21.806318582103746,
     -32.10277700635869, -31.228892845948742, -31.421266315548642, -21.667558460473455, -19.96785202203736,
     -21.390679842997272, -6.248206056569904, -42.15572921636742, -35.412664867782524, -16.63413290002853,
     -19.202501965860037, -19.319714818148988, -33.97934775229954, -0.09464059658340536, -38.86170179636542,
     -35.427192467130865, -34.11675783851694, -42.61346570969455, -36.42603566824222, -26.23343457088529,
     -35.65422112919494, -25.942640532284752, -26.097554454667215, -26.827374860348726, -11.796241019200576,
     -27.005001490562933, -35.04784644050739, -11.759007520754531, -4.739789510338907, -38.05298683336297,
     -41.62744643027655, -41.07958222374967, -39.226029686658045, -41.19922222614096, -41.35211495069607,
     -14.331767920458429, -42.71450847291565, -40.34998812533832, -39.15725705743409, -7.1798108595476355,
     -33.158195383376125, -33.29572614026015, -30.846054283073002, -32.65022551963203, -32.337849144841165,
     -33.313045197379914, -26.60471418239494, -7.43562452184715, -13.742627260124799, -26.8043480785789,
     -4.544316825465783, -26.8756590601267, -25.357664289246934, -30.17909623458151, -36.811293395939664,
     -9.696224348683485, -23.439272001515217, -22.025346641960994, -22.87369946262323, -20.70742088303377,
     -21.82338561338953, -23.668827088748465, -23.52231687805756, -30.342217837724576, -24.32962287334619,
     -23.596138137237222, -23.388061159750293, -24.24022933077141, -10.065376902568897, -9.957715089033815,
     -25.947381255954898, -26.985685774865942, -20.286774418910667, -10.94589352340241, -21.847312698852576,
     -26.207469719189724, -11.78204694093642, -21.17793216911841, -11.872887503837573, -25.386641359448415,
     -24.21402107672324, -10.284453653845883, -17.993978177167868, -17.55246762985069, -15.313936593113723,
     -15.463256202806063, -17.971875519491647, -17.112997607025893, -16.951964018162588, -12.290885085200774,
     -12.350430834842047, -16.615059257191472, -16.49450342340348, -14.768958813974551, -12.416708858527954,
     -12.0462052532374, -17.77145047491167, -14.349997507505664, -14.991023816973327, -14.07873268277849,
     -15.924784135552862, -12.697069183881453, -15.683810532565376, -19.068536639272164, -12.66169442512862,
     -11.886976967991068, -14.215448656306005, -7.529268470937349, -11.072407035118845, -8.755900578661594,
     -6.6725450815549605, -15.697839760987307, -11.990047708361715, -10.763535089235742, -6.582817214011336,
     -6.084020078460323, -6.6172800887337, -4.494289835354978, -4.848734064901341, -2.0755143290040645,
     -3.519332202151872, 0.6547942199827818, -17.29923104028024, 1.382434981630338, -4.550143765919744,
     -17.123844687734266, 3.298623722493655, -13.087827457586448, -4.687085425420475, 0.1854765176040545,
     -1.8523110290308717, -3.130077811777839, -17.43785490858881, -1.4730825811319912, -2.8402684137401963,
     0.5981129141859451, -2.001155971263262, -2.8756966675709634, -1.4478702546901794, -2.3757949374635325,
     -0.4300511967405219, -4.624538568478576, -0.5233597841002681, -0.9487534798212756, 6.727239016887982,
     -0.08481170661510416, 7.321815099477958, -33.70091250228357, 3.9132767019850334, 2.124603336810464,
     6.133224399001298, 5.209725813700986, 8.609602435475583, 9.042057122870744, 3.1120479094272975, 2.2674013384474563,
     4.587639692597992, -5.725700544221551, 4.156762760035655, 8.634505096352664, -13.442808595077125,
     5.612719333065888, 1.7282789590085872, -7.0798479218417, 4.092297339915165, 1.056880405796236, -2.2727787262127843,
     0.6259042497812476, 0.21961921727443434, -5.22484682320248, 3.012976326600985, 1.9402383042619429,
     4.150243450339346, -11.674199829426678, -6.012353793594472, 0.8865602965352692, -3.269515221592238,
     5.026505911454432, 2.1301713136777494, 2.965126835948681, 0.3656416028869821, 0.7783351440383995,
     1.8745381922592539, 3.553322146452891, 0.5469762271111897, 0.6650512020287138, 0.34353779201290546,
     -2.1798814512036184, 0.5122742919750629, 0.8613529768397516, 3.1407296207947106, -0.9048526148050821,
     -0.18408100227370824, 4.11118808902818, -2.6631307258973944, -4.2744290241115515, 3.76530208194874,
     -72.0037606030009, 2.5251175020882526, -0.07057884244149909, 0.6612299140275084, -0.19857254874467678,
     0.7099885264542757, 1.3269471369070098, 74.25922291169711, 2.5490774700063747, -0.2554179488874515,
     2.4079106503085845, 2.554065092805404, 4.59441777667572, 3.2928145391943016, 80.6199922248052, 3.1318165339056194,
     3.7341892622316153, 2.5567455039393714, 2.8146340522496622, 6.838759331613484, 3.359933010902213,
     7.823456953867901, 2.521589744688744, -68.58079045522722, -69.0027345293746, 3.3741352237778184, 6.959925525979086,
     74.21618008316138, 4.422544237823916, 1.4058343923453929, 3.6544090948327854, 5.695742546270798,
     3.4477802934300894, 6.377766524139019, 0.5109398392199412, 3.4594721931690673, -0.20479456636087562,
     1.8326010519761722, -0.6265933256582411, -3.231203797115768, -3.632506647861408, -2.786261264557257,
     1.8422658199435868, 3.788016756915195, 1.0584588765272271, 68.49225297388598, 2.470917582029445, 7.159367846445181,
     7.5259279550623965, 2.643434434249901, 7.8088039231815145, 7.58766557121153, 6.448861621763485, 5.414509966779758,
     5.976238915219743, 4.4563954563737305, 3.7501409591984385, -0.5322408333598361, 3.825088491301575,
     4.342383882801454, 2.351530265738474, 1.030106549413162, 68.85062232532763, 66.27957913162876, 1.9863892666886829,
     70.14113383734421, 70.57364619343404, -1.2977037756827308, -3.3022664618107402, 4.005496089045678,
     72.33318461509057, 4.0698566186428, 1.3984884514650586, 4.40355035080308, 2.9771363255829546, -78.76887494669542,
     2.906973114112055, 3.682573646609689, 1.7356939353370486, 0.3789679833280464, -0.7832805003366776,
     67.27496782222865, 71.65428851876679, 0.7263558132389982, -3.5198018163636813, 85.22475837188071,
     -1.537794960677138, 2.122540767832553, 2.770113875746732, 0.04265896878944857, 2.880855047485461,
     6.096920371896151, 3.5792238247164168, -0.0946983900889845, -1.431696522312714, -4.486535172501379,
     84.09958399353337, -3.635520757258275, -1.7908258899705423, 3.9240926693111007, 2.778135128785236,
     1.4645507294581932, -78.44334435696837, 5.0790215965758385, 6.527824976267033, 6.14015516569241, 84.35296524740218,
     86.99079797761267, 9.344126255197258, -72.06882722888074, 5.291751031985787, 86.17595089700575, 85.53047023376898,
     5.167203845356339, 5.167203845356339, 7.782367370761618, 7.508740416296692, -73.53926646501132, 7.283852377104903,
     8.047520935365316, 6.344761942047902, 3.1556476149691615, 4.93103187162791, 5.572249482500803, 6.530866842083075,
     3.9709056599138877, 4.0741363224051765, 5.422749507770197, 1.8398190754367745, 72.07681909223665, 5.66020527954857,
     0.1262587614259786, -2.548542768003875, -1.4116033995210928, 2.11386822531039, 3.8000548675446617,
     2.7336882192001757, 0.15054078462201487, 2.9800235183147246, 4.792961726087338, 1.4847395156427283,
     6.940703584403674, 4.246750711127158, 5.082214542508449]

    filtered_wheel = []
    wheel_filter = AlphaBeta(alpha=0.05, beta=0.001, initial_position=wheel_angle[0])
    for angle in wheel_angle:
        wheel_filter.update(angle, 1)
        filtered_wheel.append(wheel_filter.position)

    # plot both the raw and filtered data
    plt.title("Steering Angle")
    plt.plot(wheel_angle, label='raw')
    plt.plot(filtered_wheel, label='filtered')
    plt.show()

    filtered_road = []
    road_filter = AlphaBeta(alpha=0.06, beta=0.003, initial_position=road_angle[0])
    for angle in road_angle:
        road_filter.update(angle, 1)
        filtered_road.append(road_filter.position)

    # plot both the raw and filtered data
    plt.title("Road Angle")
    plt.plot(road_angle, label='raw')
    plt.plot(filtered_road, label='filtered')
    plt.show()
