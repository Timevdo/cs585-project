import matplotlib.pyplot as plt
import numpy as np


class AlphaBeta:
    alpha: float
    beta: float

    velocity: np.ndarray
    position: np.ndarray

    def __init__(self, alpha: float, beta: float, initial_position: np.ndarray):
        self.alpha = alpha
        self.beta = beta
        self.position = initial_position
        self.velocity = np.zeros_like(initial_position, dtype=np.float32)

    def update(self, measurement: np.ndarray, dt: float) -> np.ndarray:
        assert dt != 0.0
        predicted_position = self.position + self.velocity * dt
        residual = measurement - predicted_position
        self.position = predicted_position + self.alpha * residual
        self.velocity += (self.beta * residual) / dt
        return self.position

    def get_position(self) -> np.ndarray:
        return self.position

    def predict(self, dt: float) -> np.ndarray:
        self.position += self.velocity * dt
        return self.position


# Raw data to help test the filter and determine alpha/beta
if __name__ == "__main__":
    road_angle = [-150.79453848356482, -147.81489410810923, -148.3067577810692, -149.35933654424463, -148.4710119622466, -144.0800728640267, -143.28068224272175, -145.830079543407, -145.61965527615513, -143.8067926944353, -143.43690413140592, -145.63476093874033, -146.78818329910763, -148.4141024961333, -141.4698199851732, -149.48473356032298, -150.97506745679604, -150.8838537339211, -151.03233935393598, -148.86102756302114, -152.34112889497263, -152.34112889497263, -149.03624346792648, -148.74658072083034, -149.31793136312797, -148.43818815835064, -146.6258986433086, -147.24233119887444, -146.52372170389734, -151.31385242626055, -147.8388162799008, -151.8714323843272, -145.771454160198, -147.44333420789326, -146.73512525859917, -150.8838537339211, -151.21636708908252, -152.0028526387574, -150.29654731443006, -150.8838537339211, -148.73626830562256, -147.22091933193045, -142.3219082869737, -144.80249671524524, -144.31477975428976, -142.3219082869737, -142.86402479549955, -152.0028526387574, -149.03624346792648, -149.9158434412248, -149.27251338440036, -151.44037952168017, -151.8518001521377, -151.7208734438054, -151.41527967619953, -150.62423458118684, -148.60452886463207, -146.94417718844633, -145.10503636503796, -149.22246961446552, -151.2323506611562, -149.2810957359708, -151.3895403340348, -150.2125828686205, -150.7856200197316, -147.69266554511788, -148.25471257764477, -150.66002913184354, -150.17291534552524, -148.97735779542919, -147.3311394659881, -143.61564818416412, -150.81919394750014, -151.1035837361874, -143.37425902759907, -146.20594750740258, -145.7842978675626, -147.02227668618352, -143.2099014383707, -148.25471257764477, -151.00740429609985, -150.72895307914413, -151.03726505711444, -143.51723010830693, -143.28579702395376, -142.8917024282357, -146.513831184487, -150.66002913184354, -144.1447716537843, -150.5363720236403, -147.0947570770121, -149.88626684901757, -149.09359658141622, -149.55137645615952, -142.8831393167297, -150.66002913184354, -146.5186593448795, -150.69492414342, -148.67130713219584, -149.62087398863164, -149.4475907148403, -149.03624346792648, -149.33811517161178, -149.27251338440036, -148.72519451768295, -148.4161834818409, -147.6118851465991, -147.02227668618352, -147.58296249407692, -146.7155595345078, -146.513831184487, -146.41335434637722, -145.5699912208271, -145.23104344451824, -144.6887865603668, -143.45891240017056, -143.45891240017056, -143.13010235415598, -142.6333305872313, -142.6333305872313, -143.13010235415598, -142.12501634890182, -142.19923363836767, -142.19923363836767, -141.86642980249772, -140.7406066389519, -139.3510779515739, -139.06336599293303, -139.63546342690265, -137.87836949973402, -137.26475454822344, -138.51654749633545, -135.66619997018313, -133.97084519569404, -131.13926737511673, -134.33380002981687, -128.74096369487776, -131.5106750942036, -126.22494425552034, -125.21759296819272, -130.76360520094119, -122.24997416418361, -128.33334010909863, -124.91183021660997, -130.1207262169933, -118.75712089730241, -124.47921568612564, -122.38067770656923, -118.73979529168805, -121.6863676878566, -116.56505117707799, -117.33235949216768, -110.22485943116808, -119.66671520694645, -119.42745640318975, -115.05761541830302, -116.56505117707799, -113.74949449286676, -115.64100582430528, -115.94229548987168, -105.94539590092286, -103.70696100407982, -100.91112838428339, -108.92464441605124, -99.86580694308438, -98.42696902148067, -99.86580694308438, -92.52611691161955, -82.4605548604907, -101.30993247402021, -104.42077312751098, -90.70731936854426, -100.98065001017355, -106.05998730716065, -87.82525588538995, -86.59355624500529, -103.10920819815429, -92.04540848888723, -96.49934627965457, -94.9392155421262, -101.02345596374315, -87.95459151111278, -100.75096699318806, -87.3057157101439, -83.9559078377589, -100.71312302279104, -100.85641334806225, -82.23483398157467, -95.71059313749964, -104.62087398863166, -79.99202019855866, -101.30993247402021, -84.8055710922652, -82.8749836510982, -81.46923439005187, -82.78573796079324, -84.21760767763595, -82.78573796079324, -79.11447294534128, -81.02737338510362, -77.95742485711503, -77.95742485711503, -80.78897345918332, -78.54124765412281, -79.76519723657678, -78.84534026107171, -77.79953127261922, -75.78414652632645, -80.41705527646744, -80.77011375627228, -81.46923439005187, -82.45057823173673, -81.098283967108, -79.2157021324374, -82.62623363866979, -79.33965170546468, -76.7594800848128, -82.71104767638988, -80.75388725443676, -76.27770286686646, -78.81824578980333, -78.17851165939275, -79.46081627137177, -27.474431626277134, -79.46081627137177, -79.99202019855866, -78.55895613123258, -81.86989764584403, -78.55895613123258, -77.61924307119283, -80.99149625797484, -78.69006752597979, -79.24903300681196, -80.53767779197439, -83.418055344822, -80.07375449334829, -83.73650938566547, -81.098283967108, -84.62329457194926, -82.14668669802178, -82.05652818940959, -81.50144112050633, -81.50144112050633, -83.58915997976756, -81.59662890943918, -78.94358701975182, -79.5792876032055, -79.69515353123397, -84.68545433005525, -83.51692630710276, -84.0938588862295, -77.39984017391933, -78.69006752597979, -142.4715591765924, -73.87242417404019, -88.63607246839707, -81.86989764584403, -76.4520610119995, -78.4248111826038, -77.61924307119283, -74.33183957824751, -79.75591255354138, -76.2930389959202, -111.74077905447172, -73.68614757373945, -79.8753283446022, -75.15454791791618, -80.42577211490818, -75.80144597613683, -79.99202019855866, -77.66091272167381, -72.80145877993414, -77.25471052686716, -76.6075022462489, -76.122470196792, -78.69006752597979, -82.53943387383165, -70.9533757023642, -70.9533757023642, -73.42599224309102, -76.6075022462489, -78.69006752597979, -72.80145877993414, -80.42577211490818, -77.76388849058367, -73.68614757373945, -77.76388849058367, -74.80475147318012, -73.68614757373945, -72.84757825978816, -73.68614757373945, -74.51149855709032, -78.04341575685088, -79.8753283446022, -76.2930389959202, -76.13031356149496, -71.1468412355809, -76.9543629370514, -75.6354175503028, -79.08887161571661, -76.4520610119995, -86.55261314813481, -71.35820810630067, -74.51149855709032, -71.35820810630067, -94.08561677997488, -75.32360686254998, -81.20258929000894, -71.98023071822286, -82.53943387383165, -75.15454791791618, -91.38035407344445, -79.2157021324374, -77.76388849058367, -96.11550356628541, -74.05460409907715, -77.9052429229879, -99.35297925009326, -73.61045966596522, -77.05349048436307, -76.42956561483852, -78.43986920578224, -78.56631873457333, -79.80849814997231, -83.6598082540901, -78.69006752597979, -78.3106308245608, -75.1916229609576, -84.62329457194926, -90.0, -83.6598082540901, -73.10135130596177, -75.43972438064313, -74.55368363230745, -75.78414652632645, -74.2679952148927, -75.57922687248902, -72.8380811971347, -61.020292302071226, -66.5953104489677, -74.05460409907715, -73.73979529168804, -73.44292862436335, -71.34211152588047, -72.43972794819932, -75.29169610031725, -74.98163936884933, -75.48894049983093, -78.3106308245608, -75.96375653207353, -72.34987578006988, -77.60459316624154, -78.43986920578224, -78.94358701975182, -78.81824578980333, -75.48894049983093, -79.33965170546468, -79.63367739654952, -82.26640190097714, -79.50852298766841, -73.10135130596177, -78.00310069207643, -72.64597536373867, -78.69006752597979, -74.24882633654697, -75.11373315098244, -77.855721950433, -77.31961650818018, -73.10135130596177, -66.37062226934319, -73.30075576600639, -72.84757825978816, -73.7676493388438, -96.26349061433454, -74.43848967467152, -80.53767779197439, -76.3099503825345, -99.68878656036681, -73.30075576600639, -78.95905981967627, -75.15454791791618, -77.39984017391933, -79.46081627137177, -75.02712423321309, -76.90810693565317, -73.79097507219203, -78.94358701975182, -77.39984017391933, -67.61986494804043, -72.37770277133174, -71.36541512255361, -78.3106308245608, -82.05652818940959, -72.34987578006988, -78.43986920578224, -77.81634341401261, -71.76750891929619, -82.05652818940959, -72.57013718233218, -70.5599651718238, -66.4767909795404, -68.19859051364818, -70.9533757023642, -64.8321298502184, -72.20401107606962, -72.20401107606962, -80.07375449334829, -106.50436138175503, -72.89727103094764, -76.3099503825345, -71.13100054493859, -67.58385252065636, -66.37062226934319, -68.68208772453845, -67.22962109123779, -63.718588978679826, -65.17945866451092, -60.88385373392108, -61.44037952168017, -62.57125877832243, -64.59228189105153, -72.64597536373867, -59.78867761416518, -62.57125877832243, -61.13284053048539, -57.188633201931886, -55.7842978675626, -75.78414652632645, -81.54497232282256, -60.67952412241925, -71.32329826780989, -77.9052429229879, -47.152962789100464, -72.59729586864373, -63.10376303450663, -55.00797980144134, -74.05460409907715, -72.5528115767178, -48.81407483429036, -55.22216863363612, -55.38885781546961, -74.67848992513521, -48.22452260651991, -45.38976119531806, -50.42059528376237, -43.15238973400541, -46.56935480474898, -49.08561677997488, -45.763898460929994, -46.16913932790742, -33.91743053697035, -34.03661035367036, -36.780790751100945, -38.078882361565, -36.96055544916336, -33.45950225339066, -33.006651276413024, -32.66091272167381, -29.275254277252575, -33.8112000717482, -32.5039889555625, -30.61138840686757, -30.256437163529263, -27.24508784252073, -29.134292197226177, -26.911245027538953, -24.211754310969685, -24.973910905883404, -30.352624727637004, -26.56505117707799, -26.236712195307263, -25.362166948931176, -29.59657503753038, -27.989238495323775, -28.779806304397212, -28.918348043186292, -27.486619624287954, -28.417638059017083, -28.092576619290917, -28.30075576600638, -29.337893654673955, -28.37552185603504, -27.19812794850912, -28.072486935852957, -27.724056235971393, -25.924901507554456, -27.235146699302526, -26.397520135476125, -28.19130837379314, -36.06438615741825, -32.005383208083494, -25.683647180495853, -25.683647180495853, -24.695526290039563, -25.709953780811265, -26.39503452619769, -26.896236965493376, -27.56720750091564, -28.429048833086146, -29.054604099077146, -28.875443396228107]

    wheel_angle = [-34.064559287735044, -20.227651157807458, -21.939490427969805, -21.048622840176073, -22.210661833734292, -28.08313546968811, -28.026190625178998, -27.901144490443187, -16.56135843501313, -16.705796645640575, -17.026129889215785, -16.937958548715994, -16.59955661397902, -16.895022817867567, -17.65873611923832, -17.03662336584595, -17.068035584472174, -16.78076321350495, -16.378821551921366, -15.960992213232709, -15.501969802461506, -15.630901420330447, -16.486401186334117, -36.124213846603794, -16.289751464695296, -16.02099218592109, -15.588436214229896, -16.788767350047365, -16.293729333064725, -16.068028763086573, -24.792382550483076, -29.925087480584963, -34.190121646518314, -17.10824392713804, -18.234619901469312, -20.462230986578547, -21.263846604796893, -31.935134519729907, -20.435702069781044, -20.028697905557074, -38.584027508467926, -36.630933433955484, -36.0380599451167, -18.47500954278759, -35.89147793170257, -26.200940987429522, -17.278861707066014, -18.40112496895062, -40.79991816258978, -18.40913871061336, -19.21907572745197, -37.68510865102145, -39.57653816364356, -39.71114365895097, -39.11979204438823, -38.532309230730434, -36.92144991226667, -35.557802744353424, -37.23467119709668, -32.54309139603384, -47.61028006205532, -32.41680585681477, -31.467756903403338, -21.806318582103746, -32.10277700635869, -31.228892845948742, -31.421266315548642, -21.667558460473455, -19.96785202203736, -21.390679842997272, -31.64865392867358, -42.15572921636742, -35.412664867782524, -31.25832936443396, -19.202501965860037, -19.319714818148988, -33.97934775229954, -38.633018444371494, -38.86170179636542, -35.427192467130865, -34.11675783851694, -18.95918396476482, -36.42603566824222, -26.23343457088529, -35.65422112919494, -25.942640532284752, -26.097554454667215, -26.827374860348726, -39.931191632790124, -27.005001490562933, -35.04784644050739, -36.72343928693084, -34.423180283026454, -38.05298683336297, -41.62744643027655, -41.07958222374967, -39.226029686658045, -41.19922222614096, -41.35211495069607, -40.75238121795957, -42.71450847291565, -40.34998812533832, -39.15725705743409, -35.3164965678341, -33.158195383376125, -33.29572614026015, -30.846054283073002, -32.65022551963203, -32.337849144841165, -33.313045197379914, -26.60471418239494, -26.97363356444621, -26.6993964512, -26.8043480785789, -24.192623732835546, -26.8756590601267, -25.357664289246934, -30.17909623458151, -27.599065622988267, -29.565221143850675, -23.439272001515217, -22.025346641960994, -22.87369946262323, -20.70742088303377, -21.82338561338953, -23.668827088748465, -23.52231687805756, -30.342217837724576, -24.32962287334619, -23.596138137237222, -23.388061159750293, -24.24022933077141, -26.78517862902591, -25.850925945585676, -25.947381255954898, -26.985685774865942, -20.286774418910667, -24.11514638426303, -21.847312698852576, -26.207469719189724, -22.170629287975324, -21.17793216911841, -25.031478541678258, -25.386641359448415, -24.21402107672324, -21.239045630169436, -17.993978177167868, -17.55246762985069, -15.313936593113723, -15.463256202806063, -17.971875519491647, -17.112997607025893, -16.951964018162588, -14.931505481575504, -17.11345823247584, -16.615059257191472, -16.49450342340348, -14.768958813974551, -12.416708858527954, -12.0462052532374, -17.77145047491167, -14.349997507505664, -14.991023816973327, -12.752302076609169, -12.752499118687034, -12.697069183881453, -15.683810532565376, -19.513142539021135, -12.66169442512862, -11.886976967991068, -14.215448656306005, -7.529268470937349, -11.072407035118845, -8.755900578661594, -6.6725450815549605, -3.718139892095773, -11.990047708361715, -10.763535089235742, -6.582817214011336, -6.084020078460323, -6.6172800887337, -4.494289835354978, -4.848734064901341, -2.0755143290040645, -3.519332202151872, 0.6547942199827818, -9.117291086771033, 1.382434981630338, -4.550143765919744, 4.793945167565153, 3.298623722493655, 3.294642979892151, -4.687085425420475, 0.1854765176040545, -1.8523110290308717, -3.130077811777839, -5.374332443804271, -1.4730825811319912, -2.8402684137401963, 0.5981129141859451, -2.001155971263262, -2.8756966675709634, -1.4478702546901794, -2.3757949374635325, -0.4300511967405219, -4.624538568478576, -0.5233597841002681, -0.9487534798212756, 6.727239016887982, -0.08481170661510416, 7.321815099477958, 3.6303538953304044, 3.9132767019850334, 2.124603336810464, 6.133224399001298, 5.209725813700986, 8.609602435475583, 9.042057122870744, 3.1120479094272975, 2.2674013384474563, 4.587639692597992, 3.7715283128512977, 4.156762760035655, 8.634505096352664, 3.007321341822553, 5.612719333065888, 1.7282789590085872, 6.980239671943894, 4.092297339915165, 1.056880405796236, -2.2727787262127843, 0.6259042497812476, 0.21961921727443434, 2.133941333637825, 3.012976326600985, 1.9402383042619429, 4.150243450339346, -0.018401304188554315, 4.212225429448275, 0.8865602965352692, 3.492603284900424, 5.026505911454432, 2.1301713136777494, 2.965126835948681, 0.3656416028869821, 0.7783351440383995, 1.8745381922592539, 3.553322146452891, 0.5469762271111897, 0.6650512020287138, 0.34353779201290546, -2.1798814512036184, 0.5122742919750629, 0.8613529768397516, 3.1407296207947106, -0.9048526148050821, -0.18408100227370824, 4.11118808902818, -2.6631307258973944, -4.2744290241115515, 3.76530208194874, -2.1799018761113635, 2.5251175020882526, -0.07057884244149909, 0.6612299140275084, -0.19857254874467678, 0.7099885264542757, 1.3269471369070098, 0.3215771960305688, 2.5490774700063747, -0.2554179488874515, 2.4079106503085845, 2.554065092805404, 4.59441777667572, 3.2928145391943016, 5.577730394232007, 3.1318165339056194, 3.7341892622316153, 2.5567455039393714, 2.8146340522496622, 6.838759331613484, 3.359933010902213, 7.823456953867901, 2.521589744688744, 5.301761090097359, 1.795021908713794, 3.3741352237778184, 6.959925525979086, 3.310554821571561, 4.422544237823916, 1.4058343923453929, 3.6544090948327854, 5.695742546270798, 3.4477802934300894, 6.377766524139019, 0.5109398392199412, 3.4594721931690673, -0.20479456636087562, 1.8326010519761722, -0.6265933256582411, -3.231203797115768, -3.632506647861408, -2.786261264557257, 1.8422658199435868, 3.788016756915195, 1.0584588765272271, 0.6825630669715054, 2.470917582029445, 7.159367846445181, 7.5259279550623965, 2.643434434249901, 7.8088039231815145, 7.58766557121153, 6.448861621763485, 5.414509966779758, 5.976238915219743, 4.4563954563737305, 3.7501409591984385, -0.5322408333598361, 3.825088491301575, 4.342383882801454, 2.351530265738474, 1.030106549413162, -1.15223540062609, 1.7009319424484528, 1.9863892666886829, 3.728225504788519, -1.642870546233244, -1.2977037756827308, -3.3022664618107402, 4.005496089045678, 2.7460931437460627, 4.0698566186428, 1.3984884514650586, 4.40355035080308, 2.9771363255829546, -0.35060989679887405, 2.906973114112055, 3.682573646609689, 1.7356939353370486, 0.3789679833280464, -0.7832805003366776, 2.127825482942428, 1.1227157338995624, 0.7263558132389982, -3.5198018163636813, 3.05227979139487, -1.537794960677138, 2.122540767832553, 2.770113875746732, 0.04265896878944857, 2.880855047485461, 6.096920371896151, 3.5792238247164168, -0.0946983900889845, -1.431696522312714, -4.486535172501379, -5.584762249172335, -3.635520757258275, -1.7908258899705423, 3.9240926693111007, 2.778135128785236, 1.4645507294581932, 7.55415573501646, 5.0790215965758385, 6.527824976267033, 6.14015516569241, 8.14534384817859, 8.840495856062738, 9.344126255197258, 8.737804231454431, 5.291751031985787, 3.5512521985197116, 3.443985166539259, 5.167203845356339, 5.167203845356339, 7.782367370761618, 7.508740416296692, 7.037530438586759, 7.283852377104903, 8.047520935365316, 6.344761942047902, 3.1556476149691615, 4.93103187162791, 5.572249482500803, 6.530866842083075, 3.9709056599138877, 4.0741363224051765, 5.422749507770197, 1.8398190754367745, 4.7053111927586695, 5.66020527954857, 0.1262587614259786, -2.548542768003875, -1.4116033995210928, 2.11386822531039, 3.8000548675446617, 2.7336882192001757, 0.15054078462201487, 2.9800235183147246, 4.792961726087338, 1.4847395156427283, 6.940703584403674, 4.246750711127158, 5.082214542508449, 2.0005818039381302, 4.0761799234905585, 5.63918333954432, 7.931686754624959, 5.542509246857641, 2.4123977141876276, 2.2453620736071764, 4.095064162933237, 4.666113429457374, 7.354700839832637, 2.649311583385493, 3.8816111112305203, -0.725498769526557, 2.686978815863618, 5.4322273033457025, 3.4998601283312896, 2.6145645783952642, 5.650550281126471, 8.888345148479338, 7.785608257013587, 0.5161035163419373, 4.495594244596113, 6.972277540536713, 4.980160068004945, 2.353012521120623, 4.309912942511435, 0.7836518444565281, 3.0205570338304706, 0.9209408618949464, 2.1747995866224454, 3.2167606415976513, 6.259119615193174, 4.155571712435434, 4.154981601784441, 5.860319736270184, 1.8752119348758112, 4.684528317229458, 1.6366716754981538, 2.049105955372672, 0.5079867986813702, 7.244900772869235, 4.524681920696559, 1.7390663049979198, 9.321645415328073, 4.915245058344949, -0.14860501502105633, 4.539422665653355, 2.450202902173073, 8.965947745493105, 5.727230249534146, 13.24986079318835, 1.1948348405953433, 5.567010975268551, 6.797019882093385, 9.980071976904487, 1.2651337941469116, 2.3337852295617245, 3.4334921967014873, 5.6871353284201165, 4.9561827218846455, 3.505857047830418, 7.1680256695796984, 4.6945911559012865, 3.2860058171943196, 5.6301318304476515, 3.7212732923653578, 7.884473603893821, 7.537472658159451, 6.0066004006550315, 9.98926815624935, 8.706899385379346, 12.36684495325638, 11.18479495532633, 11.124867729176794, 8.7711910690007, 10.84265046443506, 11.287338741821982, 10.128378129071125, 10.307958096565228, 10.755240802073832, 13.522055897963822, 10.97513756497297, 16.446634098321127, 19.498316665178614, 21.536755607871378, 20.48676531220483, 20.78679144502236, 19.34042940370466, 20.77591825523989, 22.07279457164508, 20.38298336107633, 18.0157957772044, 22.90536723254968, 17.351930108200932, 24.636284839599092, 25.4485019034636, 27.447967390703546, 25.955587377421992, 29.075897811174375, 31.231034388620497]

    filtered_wheel = []
    wheel_filter = AlphaBeta(alpha=0.04, beta=0.001, initial_position=wheel_angle[0])
    for angle in wheel_angle:
        wheel_filter.update(angle, 1)
        filtered_wheel.append(wheel_filter.position)

    # plot both the raw and filtered data
    plt.title("Steering Angle")
    plt.plot(wheel_angle, label='Raw')
    plt.plot(filtered_wheel, label='Filtered')
    plt.legend()
    plt.show()

    filtered_road = []
    road_filter = AlphaBeta(alpha=0.04, beta=0.003, initial_position=road_angle[0])
    for angle in road_angle:
        road_filter.update(angle, 1)
        filtered_road.append(road_filter.position)

    # plot both the raw and filtered data
    plt.title("Road Angle")
    plt.plot(road_angle, label='Raw')
    plt.plot(filtered_road, label='Filtered')
    plt.legend()
    plt.show()
